<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>دليل - Daleel</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary-color: #2D5F7C;
      --secondary-color: #FF9800;
      --accent-color: #4CAF50;
      --light-color: #f5f7f9;
      --dark-color: #333;
      --gray-color: #e0e0e0;
      --danger-color: #f44336;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body { 
      font-family: 'Cairo', sans-serif; 
      background: var(--light-color); 
      margin: 0; 
      padding: 0; 
      color: var(--dark-color);
      line-height: 1.6;
    }
    
    header { 
      background: var(--primary-color); 
      color: white; 
      padding: 15px; 
      text-align: center;
      position: relative;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .container { 
      max-width: 1000px; 
      margin: auto; 
      padding: 20px; 
    }
    
    .service-card { 
      background: white; 
      padding: 20px; 
      margin: 15px 0; 
      border-radius: 8px; 
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .service-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .verified { 
      color: var(--accent-color); 
      font-weight: bold; 
    }
    
    .pending { 
      color: var(--secondary-color); 
      font-weight: bold; 
    }
    
    .vote-btn { 
      border: none; 
      background: none; 
      cursor: pointer; 
      font-size: 1.2rem; 
      margin: 0 5px; 
      transition: transform 0.2s;
    }
    
    .vote-btn:hover {
      transform: scale(1.2);
    }
    
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-family: 'Cairo', sans-serif;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    
    .btn-primary {
      background: var(--primary-color);
      color: white;
    }
    
    .btn-primary:hover {
      background: #1e4660;
    }
    
    .btn-secondary {
      background: var(--secondary-color);
      color: white;
    }
    
    .btn-secondary:hover {
      background: #e68900;
    }
    
    .btn-outline {
      background: transparent;
      border: 1px solid var(--primary-color);
      color: var(--primary-color);
    }
    
    .btn-outline:hover {
      background: var(--primary-color);
      color: white;
    }
    
    .auth-form, .service-form { 
      display: none; 
      margin-bottom: 20px; 
      background: white; 
      padding: 20px; 
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    input, textarea, select {
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      border: 1px solid var(--gray-color);
      border-radius: 6px;
      font-family: 'Cairo', sans-serif;
    }
    
    .user-info {
      position: absolute;
      left: 20px;
      top: 50%;
      transform: translateY(-50%);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .user-info span {
      margin-right: 10px;
    }
    
    .filters {
      display: flex;
      gap: 10px;
      margin: 20px 0;
      flex-wrap: wrap;
    }
    
    .filter-select {
      flex: 1;
      min-width: 150px;
    }
    
    .service-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .service-meta {
      display: flex;
      gap: 15px;
      margin: 10px 0;
      flex-wrap: wrap;
    }
    
    .meta-item {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .loading {
      text-align: center;
      padding: 20px;
      color: var(--primary-color);
    }
    
    .empty-state {
      text-align: center;
      padding: 40px;
      color: #777;
    }
    
    .empty-state i {
      font-size: 3rem;
      margin-bottom: 15px;
      color: var(--gray-color);
    }
    
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      border-radius: 5px;
      color: white;
      z-index: 1000;
      opacity: 0;
      transform: translateY(-20px);
      transition: opacity 0.3s, transform 0.3s;
      max-width: 400px;
    }
    
    .notification.success {
      background-color: var(--accent-color);
      opacity: 1;
      transform: translateY(0);
    }
    
    .notification.error {
      background-color: var(--danger-color);
      opacity: 1;
      transform: translateY(0);
    }
    
    .help-box {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin: 20px 0;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .help-step {
      margin-bottom: 15px;
      padding-bottom: 15px;
      border-bottom: 1px solid var(--gray-color);
    }
    
    .help-step:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }
    
    @media (max-width: 768px) {
      .user-info {
        position: static;
        transform: none;
        justify-content: center;
        margin-top: 10px;
      }
      
      .filters {
        flex-direction: column;
      }
      
      .service-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }
      
      .notification {
        left: 20px;
        right: 20px;
        text-align: center;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>📍 دليل - Daleel</h1>
    <div class="user-info" id="userInfo" style="display: none;">
      <span id="userEmail"></span>
      <button class="btn btn-outline" onclick="logout()">تسجيل الخروج</button>
    </div>
  </header>

  <div id="notification" class="notification"></div>

  <div class="container">
    <!-- مساعدة إصلاح Firebase -->
    <div class="help-box" id="firebaseHelp" style="display: none;">
      <h2>إصلاح مشكلة Firebase</h2>
      <div class="help-step">
        <h3>الخطوة 1: التحقق من إعدادات Firebase</h3>
        <p>1. انتقل إلى <a href="https://console.firebase.google.com/" target="_blank">Firebase Console</a></p>
        <p>2. اختر مشروع "daleel-c4204"</p>
        <p>3. انتقل إلى الإعدادات (⚙️) → إعدادات المشروع</p>
      </div>
      <div class="help-step">
        <h3>الخطوة 2: نسخ بيانات التكوين</h3>
        <p>1. انسخ بيانات التكوين من قسم "تطبيقاتك"</p>
        <p>2. استبدل بيانات التكوين في الكود بالبيانات الجديدة</p>
      </div>
      <div class="help-step">
        <h3>الخطوة 3: تمكين خدمات Firebase</h3>
        <p>1. في Authentication → Sign-in method، تأكد من تمكين "البريد الإلكتروني/كلمة المرور"</p>
        <p>2. في Firestore Database، أنشئ قاعدة بيانات إذا لم تكن موجودة</p>
      </div>
    </div>

    <!-- Auth Section -->
    <div id="authSection">
      <div style="text-align: center; margin: 20px 0;">
        <button class="btn btn-primary" onclick="showForm('loginForm')">تسجيل الدخول</button>
        <button class="btn btn-secondary" onclick="showForm('registerForm')">إنشاء حساب</button>
      </div>

      <form id="loginForm" class="auth-form">
        <h3>تسجيل الدخول</h3>
        <input type="email" id="loginEmail" placeholder="البريد الإلكتروني" required>
        <input type="password" id="loginPassword" placeholder="كلمة المرور" required>
        <button type="submit" class="btn btn-primary" style="width: 100%;">دخول</button>
      </form>

      <form id="registerForm" class="auth-form">
        <h3>إنشاء حساب</h3>
        <input type="email" id="registerEmail" placeholder="البريد الإلكتروني" required>
        <input type="password" id="registerPassword" placeholder="كلمة المرور (6 أحرف على الأقل)" required>
        <button type="submit" class="btn btn-primary" style="width: 100%;">تسجيل</button>
      </form>
    </div>

    <div id="mainContent" style="display: none;">
      <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
        <button class="btn btn-secondary" onclick="toggleAddForm()">
          <i class="fas fa-plus"></i> إضافة خدمة جديدة
        </button>
        
        <div class="filters">
          <select class="filter-select" id="categoryFilter" onchange="loadServices()">
            <option value="">جميع الأقسام</option>
            <option value="حكومي">حكومي</option>
            <option value="صحة">صحة</option>
            <option value="تعليم">تعليم</option>
            <option value="مواصلات">مواصلات</option>
            <option value="أخرى">أخرى</option>
          </select>
          
          <select class="filter-select" id="sortBy" onchange="loadServices()">
            <option value="newest">الأحدث أولاً</option>
            <option value="oldest">الأقدم أولاً</option>
            <option value="mostVoted">الأكثر تصويتاً</option>
            <option value="leastVoted">الأقل تصويتاً</option>
          </select>
        </div>
      </div>

      <!-- Add Service Form -->
      <form id="serviceForm" class="service-form">
        <h3>إضافة خدمة جديدة</h3>
        <input type="text" id="serviceName" placeholder="اسم الخدمة" required>
        <select id="serviceCategory" required>
          <option value="">اختر القسم</option>
          <option value="حكومي">حكومي</option>
          <option value="صحة">صحة</option>
          <option value="تعليم">تعليم</option>
          <option value="مواصلات">مواصلات</option>
          <option value="أخرى">أخرى</option>
        </select>
        <input type="text" id="serviceLocation" placeholder="المكان" required>
        <textarea id="serviceDocuments" placeholder="الأوراق المطلوبة" required></textarea>
        <input type="text" id="serviceCost" placeholder="التكلفة (اختياري)">
        <input type="text" id="serviceDuration" placeholder="المدة المتوقعة (اختياري)">
        <div style="display: flex; gap: 10px;">
          <button type="submit" class="btn btn-primary">إضافة الخدمة</button>
          <button type="button" class="btn btn-outline" onclick="toggleAddForm()">إلغاء</button>
        </div>
      </form>

      <!-- Services List -->
      <div id="servicesContainer">
        <div class="loading">
          <i class="fas fa-spinner fa-spin"></i>
          <p>جاري تحميل الخدمات...</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase v9 SDK -->
  <script type="module">
    // استيراد وظائف Firebase التي نحتاجها
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, updateDoc, doc, orderBy, query, where, increment } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

    // 🔧 بيانات مشروعك من Firebase - استبدل هذه البيانات بالبيانات من Firebase Console
    const firebaseConfig = {
      apiKey: "AIzaSyB6TzN-QHVUOwizABYxmQY8fkqTp1qb_qA",
      authDomain: "daleel-c4204.firebaseapp.com",
      projectId: "daleel-c4204",
      storageBucket: "daleel-c4204.firebasestorage.app",
      messagingSenderId: "864882936232",
      appId: "1:864882936232:web:5bfc14da7c035ff025b59d",
      measurementId: "G-3ZFEC0TE93"
    };

    // ✅ تهيئة Firebase
    let app;
    let db;
    let auth;

    try {
      app = initializeApp(firebaseConfig);
      db = getFirestore(app);
      auth = getAuth(app);
      
      // إخفاء رسالة المساعدة إذا تم تهيئة Firebase بنجاح
      document.getElementById('firebaseHelp').style.display = 'none';
    } catch (error) {
      console.error("خطأ في تهيئة Firebase:", error);
      // عرض رسالة المساعدة إذا فشل التهيئة
      document.getElementById('firebaseHelp').style.display = 'block';
      showNotification("خطأ في تهيئة Firebase. يرجى التحقق من الإعدادات.", false);
    }

    const servicesContainer = document.getElementById("servicesContainer");
    const serviceForm = document.getElementById("serviceForm");
    const authSection = document.getElementById("authSection");
    const mainContent = document.getElementById("mainContent");
    const userInfo = document.getElementById("userInfo");
    const userEmail = document.getElementById("userEmail");
    const notification = document.getElementById("notification");

    // حالة التطبيق
    let currentUser = null;

    // وظيفة لعرض الإشعارات
    function showNotification(message, isSuccess = true) {
      notification.textContent = message;
      notification.className = isSuccess ? 'notification success' : 'notification error';
      
      setTimeout(() => {
        notification.className = 'notification';
      }, 3000);
    }

    // تهيئة التطبيق
    function initApp() {
      if (!auth) {
        showNotification("لم يتم تهيئة Firebase بشكل صحيح", false);
        return;
      }

      // مراقبة حالة المصادقة
      onAuthStateChanged(auth, async (user) => {
        if (user) {
          currentUser = user;
          userEmail.textContent = user.email;
          userInfo.style.display = 'flex';
          authSection.style.display = 'none';
          mainContent.style.display = 'block';
          await loadServices();
        } else {
          currentUser = null;
          userInfo.style.display = 'none';
          authSection.style.display = 'block';
          mainContent.style.display = 'none';
        }
      });
    }

    // Toggle Add Form
    function toggleAddForm() {
      serviceForm.style.display = serviceForm.style.display === "none" ? "block" : "none";
    }

    // Show Auth Forms
    function showForm(formId) {
      document.getElementById("loginForm").style.display = "none";
      document.getElementById("registerForm").style.display = "none";
      document.getElementById(formId).style.display = "block";
    }

    // Register
    document.getElementById("registerForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const email = document.getElementById("registerEmail").value;
      const password = document.getElementById("registerPassword").value;
      
      if (password.length < 6) {
        showNotification("كلمة المرور يجب أن تكون 6 أحرف على الأقل", false);
        return;
      }
      
      try {
        await createUserWithEmailAndPassword(auth, email, password);
        showNotification("تم إنشاء الحساب بنجاح ✅");
        document.getElementById("registerForm").reset();
      } catch (err) { 
        showNotification(err.message, false);
      }
    });

    // Login
    document.getElementById("loginForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const email = document.getElementById("loginEmail").value;
      const password = document.getElementById("loginPassword").value;
      try {
        await signInWithEmailAndPassword(auth, email, password);
        showNotification("تم تسجيل الدخول بنجاح ✅");
        document.getElementById("loginForm").reset();
      } catch (err) { 
        showNotification(err.message, false);
      }
    });

    // Logout
    function logout() {
      if (confirm("هل تريد تسجيل الخروج؟")) {
        signOut(auth);
      }
    }

    // Add Service
    serviceForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      
      if (!currentUser) {
        showNotification("يجب تسجيل الدخول أولاً", false);
        return;
      }
      
      const serviceData = {
        name: document.getElementById("serviceName").value,
        category: document.getElementById("serviceCategory").value,
        location: document.getElementById("serviceLocation").value,
        documents: document.getElementById("serviceDocuments").value,
        cost: document.getElementById("serviceCost").value || "غير محدد",
        duration: document.getElementById("serviceDuration").value || "غير محددة",
        createdAt: new Date(),
        votes: 0,
        verified: false,
        userId: currentUser.uid
      };
      
      try {
        await addDoc(collection(db, "services"), serviceData);
        showNotification("تمت إضافة الخدمة بنجاح ✅");
        serviceForm.reset();
        toggleAddForm();
        await loadServices();
      } catch (err) { 
        console.error(err);
        showNotification("حدث خطأ أثناء إضافة الخدمة", false);
      }
    });

    // Load Services
    async function loadServices() {
      servicesContainer.innerHTML = `
        <div class="loading">
          <i class="fas fa-spinner fa-spin"></i>
          <p>جاري تحميل الخدمات...</p>
        </div>
      `;
      
      try {
        const categoryFilter = document.getElementById("categoryFilter").value;
        const sortBy = document.getElementById("sortBy").value;
        
        let q;
        
        // إنشاء الاستعلام الأساسي
        if (categoryFilter) {
          q = query(collection(db, "services"), where("category", "==", categoryFilter));
        } else {
          q = query(collection(db, "services"));
        }
        
        // تطبيق الترتيب
        switch(sortBy) {
          case "newest":
            q = query(q, orderBy("createdAt", "desc"));
            break;
          case "oldest":
            q = query(q, orderBy("createdAt", "asc"));
            break;
          case "mostVoted":
            q = query(q, orderBy("votes", "desc"));
            break;
          case "leastVoted":
            q = query(q, orderBy("votes", "asc"));
            break;
          default:
            q = query(q, orderBy("createdAt", "desc"));
        }
        
        const snapshot = await getDocs(q);
        
        if (snapshot.empty) {
          servicesContainer.innerHTML = `
            <div class="empty-state">
              <i class="fas fa-inbox"></i>
              <h3>لا توجد خدمات لعرضها</h3>
              <p>كن أول من يضيف خدمة!</p>
            </div>
          `;
          return;
        }
        
        servicesContainer.innerHTML = "";
        snapshot.forEach(doc => {
          const s = doc.data();
          const card = document.createElement("div");
          card.className = "service-card";
          card.innerHTML = `
            <div class="service-header">
              <h3>${s.name}</h3>
              <span class="${s.verified ? 'verified' : 'pending'}">
                <i class="fas ${s.verified ? 'fa-check-circle' : 'fa-clock'}"></i>
                ${s.verified ? 'موثوق' : 'قيد المراجعة'}
              </span>
            </div>
            
            <div class="service-meta">
              <div class="meta-item">
                <i class="fas fa-map-marker-alt"></i>
                <span>${s.location}</span>
              </div>
              <div class="meta-item">
                <i class="fas fa-folder"></i>
                <span>${s.category}</span>
              </div>
              <div class="meta-item">
                <i class="fas fa-money-bill-wave"></i>
                <span>${s.cost}</span>
              </div>
              <div class="meta-item">
                <i class="fas fa-clock"></i>
                <span>${s.duration}</span>
              </div>
            </div>
            
            <div style="margin: 15px 0;">
              <p><b>الأوراق المطلوبة:</b></p>
              <p>${s.documents}</p>
            </div>
            
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
              <div>
                <button class="vote-btn" onclick="vote('${doc.id}', 1)">
                  <i class="fas fa-thumbs-up"></i>
                </button>
                <span>${s.votes}</span>
                <button class="vote-btn" onclick="vote('${doc.id}', -1)">
                  <i class="fas fa-thumbs-down"></i>
                </button>
              </div>
              
              <small>${formatDate(s.createdAt)}</small>
            </div>
          `;
          servicesContainer.appendChild(card);
        });
      } catch (err) {
        console.error(err);
        servicesContainer.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-exclamation-circle"></i>
            <h3>حدث خطأ أثناء تحميل الخدمات</h3>
            <p>يرجى المحاولة مرة أخرى</p>
          </div>
        `;
      }
    }

    // Voting
    async function vote(id, value) {
      if (!currentUser) {
        showNotification("يجب تسجيل الدخول أولاً للتصويت", false);
        return;
      }
      
      try {
        const serviceRef = doc(db, "services", id);
        await updateDoc(serviceRef, {
          votes: increment(value)
        });
        
        await loadServices();
      } catch (err) {
        console.error(err);
        showNotification("حدث خطأ أثناء التصويت", false);
      }
    }

    // Format Date
    function formatDate(timestamp) {
      if (!timestamp) return "";
      
      const date = timestamp.toDate();
      return new Intl.DateTimeFormat('ar-EG', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      }).format(date);
    }

    // جعل الدوال متاحة عالمياً للاستدعاء من الأحداث في HTML
    window.toggleAddForm = toggleAddForm;
    window.showForm = showForm;
    window.logout = logout;
    window.vote = vote;
    window.loadServices = loadServices;

    // Initialize the app
    if (app && auth) {
      initApp();
    }
  </script>
</body>
</html>
