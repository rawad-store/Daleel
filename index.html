<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>دليل - Daleel | دليل الخدمات الحكومية والعامة</title>
  <meta name="description" content="دليل شامل للخدمات الحكومية والعامة مع تقييمات المستخدمين والمعلومات المفصلة"/>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

    <!-- Meta Tags for Social Media Sharing -->
    <meta property="og:title" content="مكتبة الرواد -الصوة | دليل الخدمات الحكومية والعامة">
    <meta property="og:description" content="دليل شامل للخدمات الحكومية - منصة تفاعلية لمشاركة التجارب وتسهيل الوصول للخدمات العامة">
    <meta property="og:image" content="https://raw.githubusercontent.com/rawad-store/konozalkhair/main/preview.jpg">
    <meta property="og:url" content="https://rawad-store.github.io/">
    <meta property="og:type" content="website">
    <meta property="og:locale" content="ar_AR">

    <!-- Twitter Card Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="مكتبة الرواد -الصوة | دليل الخدمات الحكومية والعامة">
    <meta name="twitter:description" content="دليل شامل للخدمات الحكومية - منصة تفاعلية لمشاركة التجارب وتسهيل الوصول للخدمات العامة">
    <meta name="twitter:image" content="https://raw.githubusercontent.com/rawad-store/rawad-store.github.io/main/preview.jpg">
    
    <!-- Preload critical resources -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" as="style" onloa

  <style>
    :root{
      --primary:#2D5F7C;--secondary:#4A90E2;--accent:#F5A623;
      --text:#333;--bg:#F8F9FA;--white:#fff;--border:#E0E0E0;
      --shadow:0 2px 12px rgba(0,0,0,.08);
      --success:#27AE60;--error:#E74C3C;
    }
    *{box-sizing:border-box} body{margin:0;font-family:'Cairo',sans-serif;background:var(--bg);color:var(--text)}
    a{color:inherit}
    header{position:sticky;top:0;z-index:50;background:var(--white);box-shadow:var(--shadow)}
    .nav{max-width:1200px;margin:auto;display:flex;align-items:center;justify-content:space-between;padding:12px 16px}
    .brand{display:flex;gap:10px;align-items:center;font-weight:700;color:var(--primary)}
    .actions{display:flex;gap:8px}
    .btn{border:none;border-radius:8px;padding:.65rem 1rem;cursor:pointer;font-family:inherit}
    .btn-primary{background:var(--primary);color:var(--white)}
    .btn-outline{background:transparent;color:var(--primary);border:2px solid var(--primary)}
    .btn-danger{background:var(--error);color:#fff}
    .btn-icon{display:inline-flex;gap:.45rem;align-items:center}
    .hero{background:linear-gradient(135deg,var(--primary),var(--secondary));color:#fff;padding:40px 0}
    .hero .wrap{max-width:1200px;margin:auto;padding:0 16px;display:grid;gap:16px}
    .hero h1{margin:0 0 10px}
    .stats{display:flex;gap:24px;flex-wrap:wrap}
    .stat{background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.25);padding:12px 16px;border-radius:12px}
    .container{max-width:1200px;margin:auto;padding:24px 16px}
    .search-bar{display:flex;margin-bottom:20px;max-width:600px;margin:0 auto 30px}
    .search-bar input{flex:1;padding:12px 16px;border:2px solid var(--border);border-radius:8px 0 0 8px;font-family:inherit}
    .search-bar button{background:var(--primary);color:white;border:none;padding:0 20px;border-radius:0 8px 8px 0;cursor:pointer}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px}
    .card{background:#fff;border-radius:14px;box-shadow:var(--shadow);padding:14px;position:relative}
    .card img{width:100%;height:180px;object-fit:cover;border-radius:10px;margin-bottom:10px;background:#f3f3f3}
    .meta{display:flex;gap:8px;flex-wrap:wrap;font-size:.9rem;color:#555;margin:.5rem 0}
    .rating{display:flex;gap:3px;margin:8px 0;color:#FFC107}
    .reviews{margin-top:10px;border-top:1px solid var(--border);padding-top:10px}
    .review-item{background:#f9f9f9;padding:10px;border-radius:8px;margin-bottom:8px}
    .review-header{display:flex;justify-content:space-between;margin-bottom:5px}
    .empty{padding:48px;text-align:center;color:#777}
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.5);z-index:100}
    .modal.active{display:flex}
    .modal .box{background:#fff;border-radius:14px;max-width:520px;width:92%;box-shadow:var(--shadow);overflow:hidden;max-height:90vh;overflow-y:auto}
    .box-header{padding:14px 18px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
    .box-body{padding:16px 18px}
    .row{display:grid;gap:10px}
    .row-2{grid-template-columns:1fr 1fr}
    label{font-weight:600;color:var(--primary)}
    input, select, textarea{width:100%;padding:.7rem;border:2px solid var(--border);border-radius:8px;font-family:inherit}
    textarea{min-height:100px;resize:vertical}
    .f-end{display:flex;justify-content:flex-end;gap:8px;margin-top:10px}
    .toast-wrap{position:fixed;top:16px;right:16px;z-index:200}
    .toast{background:var(--primary);color:#fff;padding:.8rem 1rem;border-radius:8px;margin-bottom:8px;box-shadow:var(--shadow)}
    .toast.error{background:var(--error)} .toast.success{background:var(--success)}
    .contact-info{background:var(--white);padding:20px;border-radius:14px;box-shadow:var(--shadow);margin-top:30px;text-align:center}
    .contact-info h3{color:var(--primary);margin-top:0}
    .contact-links{display:flex;justify-content:center;gap:20px;margin-top:15px;flex-wrap:wrap}
    .contact-link{display:flex;align-items:center;gap:8px;text-decoration:none;color:var(--text)}
    footer{background:var(--primary);color:white;text-align:center;padding:20px;margin-top:40px}
    .tabs{display:flex;gap:10px;margin-bottom:20px;border-bottom:1px solid var(--border);padding-bottom:10px}
    .tab{background:#f1f1f1;padding:8px 16px;border-radius:6px;cursor:pointer}
    .tab.active{background:var(--primary);color:white}
    @media(max-width:600px){.row-2{grid-template-columns:1fr} .stats{justify-content:center} .contact-links{flex-direction:column;align-items:center}}
  </style>
</head>
<body>
  <!-- Header -->
  <header>
    <nav class="nav">
      <div class="brand">📍 دليل <span style="font-weight:400;color:#777">| دليلك للخدمات</span></div>
      <div class="actions">
        <button id="loginBtn" class="btn btn-outline btn-icon" onclick="openAuth('login')">دخول</button>
        <button id="registerBtn" class="btn btn-primary btn-icon" onclick="openAuth('register')">تسجيل</button>
        <button id="logoutBtn" class="btn btn-outline btn-icon" style="display:none" onclick="logout()">خروج</button>
      </div>
    </nav>
  </header>

  <!-- Hero -->
  <section class="hero">
    <div class="wrap">
      <div>
        <h1>دليلك الشامل للخدمات الحكومية والعامة</h1>
        <p style="opacity:.9">استكشف الخدمات وشارك تجربتك مع الآخرين</p>
      </div>
      <div class="stats">
        <div class="stat"><b id="statServices">0</b> خدمة</div>
        <div class="stat"><b id="statUsers">0</b> مستخدم</div>
        <div class="stat"><b id="statReviews">0</b> تقييم</div>
        <div class="stat"><button id="addServiceTop" class="btn btn-primary btn-icon" style="display:none" onclick="toggleAdd()">➕ أضف خدمة</button></div>
      </div>
    </div>
  </section>

  <!-- Search -->
  <div class="container">
    <div class="search-bar">
      <input type="text" id="searchInput" placeholder="ابحث عن خدمة..." />
      <button onclick="searchServices()"><i class="fas fa-search"></i></button>
    </div>
    
    <div class="tabs">
      <div class="tab active" data-category="">جميع الخدمات</div>
      <div class="tab" data-category="حكومي">حكومي</div>
      <div class="tab" data-category="صحة">صحة</div>
      <div class="tab" data-category="تعليم">تعليم</div>
      <div class="tab" data-category="مالي">مالي</div>
      <div class="tab" data-category="أخرى">أخرى</div>
    </div>

    <!-- Services -->
    <div id="services" class="grid"></div>
    <div id="empty" class="empty">لا توجد خدمات حالياً — كن أول من يضيف خدمة ✨</div>
  </main>

  <!-- Contact Info -->
  <div class="container">
    <div class="contact-info">
      <h3>للتواصل معنا</h3>
      <p>يسعدنا تواصلكم معنا لأي استفسارات أو مقترحات</p>
      <div class="contact-links">
        <a href="mailto:tarek500500@gmail.com" class="contact-link">
          <i class="fas fa-envelope"></i> tarek500500@gmail.com
        </a>
        <a href="https://wa.me/+201126630356?text=مرحباً، أريد الاستفسار عن خدماتكم" class="whatsapp-header" target="_blank" rel="noopener">
                    <i class="fab fa-whatsapp"></i>
        </a>
      </div>
    </div>
  </div>

         <div style="text-align: center;">
                <h4 style="margin-bottom: 1.5rem; color: var(--primary-color); font-size: 1.3rem; font-weight: 600;">تابعونا على وسائل التواصل الاجتماعي</h4>
                <div class="social-grid">
                    <a href="https://www.facebook.com/share/1FzKsPMMsG/" class="social-card" target="_blank" rel="noopener">
                        <i class="fab fa-facebook-f"></i>
                    </a>
                    <a href="https://www.facebook.com/share/18bfjxRbHH" class="social-card" target="_blank" rel="noopener">
                        <i class="fab fa-facebook-f"></i>
                    </a>
                </div>

  <!-- Footer -->
  <footer>
    <p>© 2025 دليل - Daleel. جميع الحقوق محفوظة لمكتبة الرواد بالصوة</p>
  </footer>

  <!-- Add Service Modal -->
  <div id="addModal" class="modal" aria-hidden="true">
    <div class="box" role="dialog" aria-modal="true">
      <div class="box-header">
        <h3 style="margin:0">إضافة خدمة جديدة</h3>
        <button class="btn btn-outline" onclick="toggleAdd()">إغلاق</button>
      </div>
      <form id="serviceForm" class="box-body">
        <div class="row">
          <label for="svcName">اسم الخدمة</label>
          <input id="svcName" placeholder="مثال: استخراج جواز سفر" required />
        </div>
        <div class="row row-2">
          <div>
            <label for="svcCat">القسم</label>
            <select id="svcCat" required>
              <option value="">اختر القسم</option>
              <option>حكومي</option><option>صحة</option><option>تعليم</option><option>مالي</option><option>أخرى</option>
            </select>
          </div>
          <div>
            <label for="svcLoc">المكان</label>
            <input id="svcLoc" placeholder="الشرقية - أبوحماد" required />
          </div>
        </div>
        <div class="row">
          <label for="svcDocs">الأوراق المطلوبة</label>
          <textarea id="svcDocs" placeholder="اذكر الأوراق المطلوبة..." required></textarea>
        </div>
        <div class="row row-2">
          <div>
            <label for="svcCost">التكلفة (اختياري)</label>
            <input id="svcCost" placeholder="مثال: 100 جنيه"/>
          </div>
          <div>
            <label for="svcDur">المدة المتوقعة (اختياري)</label>
            <input id="svcDur" placeholder="مثال: 3-5 أيام"/>
          </div>
        </div>
        <div class="row">
          <label for="svcNotes">ملاحظات (اختياري)</label>
          <textarea id="svcNotes" placeholder="أي معلومات إضافية مفيدة..."></textarea>
        </div>
        <div class="row">
          <label for="svcImg">صورة الخدمة (اختياري)</label>
          <input id="svcImg" type="file" accept="image/*"/>
        </div>
        <div class="f-end">
          <button type="button" class="btn" onclick="toggleAdd()">إلغاء</button>
          <button type="submit" class="btn btn-primary btn-icon">💾 حفظ</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Review Modal -->
  <div id="reviewModal" class="modal" aria-hidden="true">
    <div class="box" role="dialog" aria-modal="true">
      <div class="box-header">
        <h3 style="margin:0">تقييم الخدمة: <span id="reviewServiceName"></span></h3>
        <button class="btn btn-outline" onclick="closeReview()">إغلاق</button>
      </div>
      <div class="box-body">
        <form id="reviewForm">
          <div class="row">
            <label>التقييم</label>
            <div class="rating" id="ratingStars">
              <i class="far fa-star" data-rating="1"></i>
              <i class="far fa-star" data-rating="2"></i>
              <i class="far fa-star" data-rating="3"></i>
              <i class="far fa-star" data-rating="4"></i>
              <i class="far fa-star" data-rating="5"></i>
            </div>
            <input type="hidden" id="reviewRating" value="0" required />
          </div>
          <div class="row">
            <label for="reviewComment">التعليق (اختياري)</label>
            <textarea id="reviewComment" placeholder="اكتب تعليقك عن الخدمة..."></textarea>
          </div>
          <div class="row">
            <label for="reviewAccuracy">هل المعلومات صحيحة؟</label>
            <select id="reviewAccuracy" required>
              <option value="">اختر الإجابة</option>
              <option value="نعم">نعم، المعلومات صحيحة</option>
              <option value="جزئياً">جزئياً، بعض المعلومات تحتاج تحديث</option>
              <option value="لا">لا، المعلومات غير صحيحة</option>
            </select>
          </div>
          <div class="f-end">
            <button type="button" class="btn" onclick="closeReview()">إلغاء</button>
            <button type="submit" class="btn btn-primary btn-icon">💾 حفظ التقييم</button>
          </div>
        </form>
        
        <div class="reviews" id="serviceReviews">
          <h4>التقييمات السابقة</h4>
          <div id="reviewsList"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Auth Modal -->
  <div id="authModal" class="modal" aria-hidden="true">
    <div class="box" role="dialog" aria-modal="true">
      <div class="box-header">
        <h3 id="authTitle" style="margin:0">تسجيل الدخول</h3>
        <button class="btn btn-outline" onclick="closeAuth()">إغلاق</button>
      </div>
      <div class="box-body">
        <!-- Login -->
        <form id="loginForm" class="row" autocomplete="on">
          <div class="row">
            <label for="loginEmail">البريد الإلكتروني</label>
            <input id="loginEmail" type="email" placeholder="email@example.com" required />
          </div>
          <div class="row">
            <label for="loginPass">كلمة المرور</label>
            <input id="loginPass" type="password" placeholder="******" required />
          </div>
          <div class="f-end">
            <button type="submit" class="btn btn-primary btn-icon">➡️ دخول</button>
          </div>
        </form>

        <!-- Register -->
        <form id="registerForm" class="row" style="display:none" autocomplete="on">
          <div class="row">
            <label for="regEmail">البريد الإلكتروني</label>
            <input id="regEmail" type="email" placeholder="email@example.com" required />
          </div>
          <div class="row row-2">
            <div>
              <label for="regPass">كلمة المرور</label>
              <input id="regPass" type="password" minlength="6" placeholder="6 أحرف على الأقل" required />
            </div>
            <div>
              <label for="regConfirm">تأكيد كلمة المرور</label>
              <input id="regConfirm" type="password" minlength="6" placeholder="أعد كتابة كلمة المرور" required />
            </div>
          </div>
          <div class="f-end">
            <button type="submit" class="btn btn-primary btn-icon">📝 إنشاء حساب</button>
          </div>
        </form>

        <div style="margin-top:10px;text-align:center">
          <a href="#" onclick="switchAuth()">تبديل إلى <span id="switchLabel">إنشاء حساب</span></a>
        </div>
      </div>
    </div>
  </div>

  <!-- Toasts -->
  <div id="toasts" class="toast-wrap"></div>

  <!-- Firebase + App -->
  <script type="module">
    /* ==== Firebase SDKs ==== */
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js';
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js';
    import { getFirestore, collection, addDoc, getDocs, query, orderBy, serverTimestamp, doc, deleteDoc, where, updateDoc, arrayUnion } from 'https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js';
    import { getStorage, ref as sRef, uploadBytes, getDownloadURL, deleteObject } from 'https://www.gstatic.com/firebasejs/12.2.1/firebase-storage.js';

    /* ==== Config (خاصة بمشروعك) ==== */
    const firebaseConfig = {
      apiKey: "AIzaSyB6TzN-QHVUOwizABYxm0Y8fkqTp1qb_qA",
      authDomain: "daleel-c4204.firebaseapp.com",
      projectId: "daleel-c4204",
      storageBucket: "daleel-c4204.appspot.com",
      messagingSenderId: "864882936232",
      appId: "1:864882936232:web:5bfc14d7c0f02559d5f02d"
    };

    /* ==== Init ==== */
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    /* ==== State ==== */
    let currentUser = null;
    let services = [];
    let allServices = [];
    let currentServiceForReview = null;

    /* ==== UI Helpers ==== */
    const $ = (s, p=document) => p.querySelector(s);
    function toast(msg, type='success'){
      const el = document.createElement('div');
      el.className = `toast ${type}`;
      el.textContent = msg;
      $('#toasts').appendChild(el);
      setTimeout(()=>el.remove(), 3200);
    }

    /* ==== Auth Modal ==== */
    function openAuth(mode='login'){
      $('#authModal').classList.add('active');
      if(mode==='register'){ $('#authTitle').textContent='إنشاء حساب'; $('#loginForm').style.display='none'; $('#registerForm').style.display='grid'; $('#switchLabel').textContent='تسجيل الدخول'; }
      else { $('#authTitle').textContent='تسجيل الدخول'; $('#loginForm').style.display='grid'; $('#registerForm').style.display='none'; $('#switchLabel').textContent='إنشاء حساب'; }
    }
    function closeAuth(){ $('#authModal').classList.remove('active'); $('#loginForm').reset(); $('#registerForm').reset(); }
    function switchAuth(){ if($('#loginForm').style.display!=='none') openAuth('register'); else openAuth('login'); }
    window.openAuth = openAuth; window.closeAuth = closeAuth; window.switchAuth = switchAuth;

    /* ==== Add Modal ==== */
    function toggleAdd(){ 
      if(!currentUser){ toast('يجب تسجيل الدخول أولاً','error'); openAuth('login'); return; }
      $('#addModal').classList.toggle('active');
    }
    window.toggleAdd = toggleAdd;

    /* ==== Review Modal ==== */
    function openReview(serviceId){
      if(!currentUser){ toast('يجب تسجيل الدخول أولاً','error'); openAuth('login'); return; }
      
      const service = services.find(s => s.id === serviceId);
      if(!service) return;
      
      currentServiceForReview = service;
      $('#reviewServiceName').textContent = service.name;
      $('#reviewRating').value = '0';
      $('#reviewComment').value = '';
      $('#reviewAccuracy').value = '';
      resetStars();
      
      // تحميل التقييمات الحالية
      loadReviews(serviceId);
      
      $('#reviewModal').classList.add('active');
    }
    
    function closeReview(){
      $('#reviewModal').classList.remove('active');
      currentServiceForReview = null;
    }
    
    function resetStars(){
      const stars = $('#ratingStars').querySelectorAll('i');
      stars.forEach(star => {
        star.classList.remove('fas');
        star.classList.add('far');
      });
    }
    
    function setStars(rating){
      const stars = $('#ratingStars').querySelectorAll('i');
      stars.forEach((star, index) => {
        if(index < rating){
          star.classList.remove('far');
          star.classList.add('fas');
        } else {
          star.classList.remove('fas');
          star.classList.add('far');
        }
      });
    }
    
    // إضافة تفاعل النجوم
    document.addEventListener('DOMContentLoaded', function() {
      // تأجيل تهيئة النجوم حتى يتم تحميل DOM
      setTimeout(() => {
        const stars = $('#ratingStars')?.querySelectorAll('i');
        if(stars){
          stars.forEach(star => {
            star.addEventListener('mouseenter', function() {
              const rating = parseInt(this.getAttribute('data-rating'));
              setStars(rating);
            });
            
            star.addEventListener('mouseleave', function() {
              const currentRating = parseInt($('#reviewRating').value);
              setStars(currentRating);
            });
            
            star.addEventListener('click', function() {
              const rating = parseInt(this.getAttribute('data-rating'));
              $('#reviewRating').value = rating;
              setStars(rating);
            });
          });
        }
      }, 500);
    });

    /* ==== Search and Filter ==== */
    function searchServices(){
      const searchTerm = $('#searchInput').value.trim().toLowerCase();
      filterServices(searchTerm, $('#svcCat').value);
    }
    
    function filterServices(searchTerm = '', category = ''){
      let filtered = allServices;
      
      // التصفية حسب الفئة
      if(category){
        filtered = filtered.filter(service => service.category === category);
      }
      
      // التصفية حسب البحث
      if(searchTerm){
        filtered = filtered.filter(service => 
          service.name.toLowerCase().includes(searchTerm) || 
          service.location.toLowerCase().includes(searchTerm) ||
          service.documents.toLowerCase().includes(searchTerm)
        );
      }
      
      services = filtered;
      renderServices();
    }
    
    // إضافة أحداث للتبويبات
    document.addEventListener('DOMContentLoaded', function() {
      const tabs = document.querySelectorAll('.tab');
      tabs.forEach(tab => {
        tab.addEventListener('click', function() {
          // إزالة النشاط من جميع الألسنة
          tabs.forEach(t => t.classList.remove('active'));
          // إضافة النشاط للسان المحدد
          this.classList.add('active');
          
          // تصفية الخدمات حسب الفئة
          const category = this.getAttribute('data-category');
          const searchTerm = $('#searchInput').value.trim().toLowerCase();
          filterServices(searchTerm, category);
        });
      });
      
      // إضافة حدث للبحث عند الضغط على Enter
      $('#searchInput').addEventListener('keypress', function(e) {
        if(e.key === 'Enter') searchServices();
      });
    });

    /* ==== Auth Handlers ==== */
    $('#registerForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const email = $('#regEmail').value.trim();
      const pass  = $('#regPass').value;
      const confirm = $('#regConfirm').value;
      if(pass!==confirm){ toast('كلمات المرور غير متطابقة','error'); return; }
      try{
        await createUserWithEmailAndPassword(auth, email, pass);
        toast('تم إنشاء الحساب بنجاح'); closeAuth();
      }catch(err){ toast(mapAuthErr(err),'error'); console.error(err); }
    });

    $('#loginForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const email = $('#loginEmail').value.trim();
      const pass  = $('#loginPass').value;
      try{
        await signInWithEmailAndPassword(auth, email, pass);
        toast('تم تسجيل الدخول'); closeAuth();
      }catch(err){ toast(mapAuthErr(err),'error'); console.error(err); }
    });

    function logout(){ signOut(auth).then(()=>toast('تم تسجيل الخروج')).catch(e=>toast('خطأ: '+e.message,'error')); }
    window.logout = logout;

    function mapAuthErr(e){
      switch(e.code){
        case 'auth/email-already-in-use': return 'البريد الإلكتروني مستخدم بالفعل';
        case 'auth/invalid-email': return 'البريد الإلكتروني غير صالح';
        case 'auth/weak-password': return 'كلمة المرور ضعيفة (6 أحرف على الأقل)';
        case 'auth/user-not-found': return 'لا يوجد حساب بهذا البريد';
        case 'auth/wrong-password': return 'كلمة المرور غير صحيحة';
        default: return e.message;
      }
    }

    onAuthStateChanged(auth, (user)=>{
      currentUser = user;
      $('#loginBtn').style.display  = user ? 'none':'inline-block';
      $('#registerBtn').style.display= user ? 'none':'inline-block';
      $('#logoutBtn').style.display = user ? 'inline-block':'none';
      $('#addServiceTop').style.display = user ? 'inline-block':'none';
      loadServices(); // تحديث القائمة حسب المستخدم (لإظهار زر الحذف لمالِك الخدمة)
      loadStats();
    });

    /* ==== Add Service ==== */
    $('#serviceForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      if(!currentUser){ toast('سجّل الدخول أولاً','error'); return; }

      const name = $('#svcName').value.trim();
      const category = $('#svcCat').value;
      const location = $('#svcLoc').value.trim();
      const documents = $('#svcDocs').value.trim();
      const cost = $('#svcCost').value.trim() || 'غير محدد';
      const duration = $('#svcDur').value.trim() || 'غير محدد';
      const notes = $('#svcNotes').value.trim();
      const file = $('#svcImg').files[0];

      if(!name || !category || !location || !documents){ toast('يرجى ملء الحقول المطلوبة','error'); return; }

      try{
        let imageUrl = ''; let imagePath = '';
        if(file){
          imagePath = `services/${currentUser.uid}/${Date.now()}-${file.name}`;
          const ref = sRef(storage, imagePath);
          const snap = await uploadBytes(ref, file);
          imageUrl = await getDownloadURL(snap.ref);
        }

        await addDoc(collection(db,'services'),{
          name, category, location,
          documents, cost, duration, notes,
          imageUrl, imagePath,
          userId: currentUser.uid,
          userEmail: currentUser.email,
          reviews: [],
          averageRating: 0,
          totalReviews: 0,
          createdAt: serverTimestamp()
        });

        toast('تمت إضافة الخدمة بنجاح','success');
        $('#serviceForm').reset(); toggleAdd(); loadServices(); loadStats();
      }catch(err){ console.error(err); toast('خطأ في الإضافة: '+err.message,'error'); }
    });

    /* ==== Review Handlers ==== */
    $('#reviewForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      if(!currentUser || !currentServiceForReview){ return; }
      
      const rating = parseInt($('#reviewRating').value);
      const comment = $('#reviewComment').value.trim();
      const accuracy = $('#reviewAccuracy').value;
      
      if(!rating || !accuracy){ toast('يرجى إدخال التقييم وتحديد دقة المعلومات','error'); return; }
      
      try{
        const reviewData = {
          userId: currentUser.uid,
          userEmail: currentUser.email,
          rating: rating,
          comment: comment,
          accuracy: accuracy,
          createdAt: serverTimestamp()
        };
        
        // تحديث الخدمة بإضافة التقييم الجديد
        const serviceRef = doc(db, 'services', currentServiceForReview.id);
        await updateDoc(serviceRef, {
          reviews: arrayUnion(reviewData)
        });
        
        // إعادة حساب متوسط التقييم
        const updatedReviews = [...(currentServiceForReview.reviews || []), reviewData];
        const totalRating = updatedReviews.reduce((sum, review) => sum + review.rating, 0);
        const averageRating = totalRating / updatedReviews.length;
        
        await updateDoc(serviceRef, {
          averageRating: averageRating,
          totalReviews: updatedReviews.length
        });
        
        toast('شكراً لتقييمك الخدمة!','success');
        closeReview();
        loadServices(); // إعادة تحميل الخدمات لتحديث التقييمات
        loadStats(); // تحديث الإحصائيات
      }catch(err){ console.error(err); toast('خطأ في إضافة التقييم: '+err.message,'error'); }
    });
    
    async function loadReviews(serviceId){
      try{
        const serviceDoc = await getDocs(query(collection(db, 'services'), where('__name__', '==', serviceId)));
        if(!serviceDoc.empty){
          const serviceData = serviceDoc.docs[0].data();
          const reviews = serviceData.reviews || [];
          
          const reviewsList = $('#reviewsList');
          reviewsList.innerHTML = '';
          
          if(reviews.length === 0){
            reviewsList.innerHTML = '<p>لا توجد تقييمات بعد</p>';
            return;
          }
          
          // ترتيب التقييمات من الأحدث إلى الأقدم
          const sortedReviews = [...reviews].sort((a, b) => {
            return b.createdAt?.toDate() - a.createdAt?.toDate();
          });
          
          sortedReviews.forEach(review => {
            const reviewEl = document.createElement('div');
            reviewEl.className = 'review-item';
            
            const date = review.createdAt ? review.createdAt.toDate().toLocaleDateString('ar-EG') : 'تاريخ غير معروف';
            
            reviewEl.innerHTML = `
              <div class="review-header">
                <div>${review.userEmail || 'مستخدم'}</div>
                <div>${date}</div>
              </div>
              <div class="rating">
                ${renderStars(review.rating)}
              </div>
              <div><strong>دقة المعلومات:</strong> ${review.accuracy}</div>
              ${review.comment ? `<div>${escapeHTML(review.comment)}</div>` : ''}
            `;
            
            reviewsList.appendChild(reviewEl);
          });
        }
      }catch(err){ console.error('خطأ في تحميل التقييمات:', err); }
    }
    
    function renderStars(rating){
      let stars = '';
      for(let i = 1; i <= 5; i++){
        if(i <= rating){
          stars += '<i class="fas fa-star"></i>';
        } else {
          stars += '<i class="far fa-star"></i>';
        }
      }
      return stars;
    }

    /* ==== Load & Render Services ==== */
    async function loadServices(){
      try{
        const q = query(collection(db,'services'), orderBy('createdAt','desc'));
        const snap = await getDocs(q);
        services = [];
        allServices = [];
        snap.forEach(d => {
          const data = d.data();
          services.push({ id:d.id, ...data });
          allServices.push({ id:d.id, ...data });
        });
        renderServices();
      }catch(err){ console.error(err); toast('خطأ في تحميل الخدمات','error'); }
    }

    function renderServices(){
      const wrap = $('#services'); wrap.innerHTML = '';
      if(services.length===0){ $('#empty').style.display='block'; return; }
      $('#empty').style.display='none';

      services.forEach(s=>{
        const isOwner = currentUser && s.userId === currentUser.uid;
        const card = document.createElement('div');
        card.className='card';
        
        // عرض متوسط التقييم إن وجد
        const ratingHtml = s.averageRating ? `
          <div class="rating">
            ${renderStars(Math.round(s.averageRating))}
            <span style="color:#666;margin-right:5px">(${s.totalReviews || 0})</span>
          </div>
        ` : '<div style="color:#777;font-size:0.9rem">لا توجد تقييمات بعد</div>';
        
        card.innerHTML = `
          ${s.imageUrl ? `<img src="${s.imageUrl}" alt="${s.name}"/>` : ``}
          <h3 style="margin:.3rem 0">${s.name}</h3>
          <div class="meta"><span>🏷️ ${s.category}</span><span>📍 ${s.location}</span></div>
          ${ratingHtml}
          <p><b>الأوراق:</b> ${escapeHTML(s.documents||'')}</p>
          ${s.cost && s.cost!=='غير محدد' ? `<p><b>التكلفة:</b> ${escapeHTML(s.cost)}</p>`:''}
          ${s.duration && s.duration!=='غير محدد' ? `<p><b>المدة:</b> ${escapeHTML(s.duration)}</p>`:''}
          ${s.notes ? `<p><b>ملاحظات:</b> ${escapeHTML(s.notes)}</p>`:''}
          <small style="display:block;margin-top:8px;color:#666">أضيفت بواسطة: ${s.userEmail || '—'}</small>
          <div class="f-end" style="margin-top:10px">
            <button class="btn btn-primary btn-icon" onclick="openReview('${s.id}')">
              <i class="fas fa-star"></i> قيم الخدمة
            </button>
            ${isOwner ? `<button class="btn btn-danger btn-icon" data-id="${s.id}">🗑️ حذف</button>`:''}
          </div>
        `;
        // إرفاق حدث الحذف إذا كان المالك
        if(isOwner){
          const delBtn = card.querySelector('button.btn-danger');
          delBtn.addEventListener('click', ()=>confirmDelete(s));
        }
        wrap.appendChild(card);
      });
    }

    function escapeHTML(str){
      return String(str).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    async function confirmDelete(svc){
      if(!confirm('هل تريد حذف هذه الخدمة؟ سيتم حذف الصورة أيضاً إن وجدت.')) return;
      try{
        // 1) حذف المستند
        await deleteDoc(doc(db,'services', svc.id));
        // 2) حذف الصورة إن وُجدت
        if(svc.imagePath){
          try{ await deleteObject(sRef(storage, svc.imagePath)); }catch(e){ console.warn('Image delete warning:', e.message); }
        }
        toast('تم حذف الخدمة'); loadServices(); loadStats();
      }catch(err){ console.error(err); toast('خطأ في الحذف: '+err.message,'error'); }
    }

    /* ==== Stats ==== */
    async function loadStats(){
      try{
        const servicesSnap = await getDocs(collection(db,'services'));
        $('#statServices').textContent = servicesSnap.size;

        const users = new Set();
        let totalReviews = 0;
        
        servicesSnap.forEach(d=>{ 
          const data = d.data();
          const u = data.userId; 
          if(u) users.add(u);
          totalReviews += data.totalReviews || 0;
        });
        
        $('#statUsers').textContent = users.size;
        $('#statReviews').textContent = totalReviews;
      }catch(e){
        $('#statServices').textContent='0'; $('#statUsers').textContent='0'; $('#statReviews').textContent='0';
      }
    }

    /* ==== Global keys (Esc closes modals) ==== */
    document.addEventListener('keydown', (e)=>{
      if(e.key==='Escape'){ 
        $('#authModal').classList.remove('active'); 
        $('#addModal').classList.remove('active'); 
        $('#reviewModal').classList.remove('active');
      }
    });
    document.querySelectorAll('.modal').forEach(m=>{
      m.addEventListener('click', (e)=>{ if(e.target===m) m.classList.remove('active'); });
    });
    
    // جعل دوال البحث والتقييم متاحة عالمياً
    window.searchServices = searchServices;
    window.openReview = openReview;
    window.closeReview = closeReview;
  </script>
</body>
</html>
