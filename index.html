<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ø¯Ù„ÙŠÙ„ - Daleel | Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø­ÙƒÙˆÙ…ÙŠØ© ÙˆØ§Ù„Ø¹Ø§Ù…Ø©</title>
  <meta name="description" content="Ø¯Ù„ÙŠÙ„ Ø´Ø§Ù…Ù„ Ù„Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø­ÙƒÙˆÙ…ÙŠØ© ÙˆØ§Ù„Ø¹Ø§Ù…Ø© Ù…Ø¹ ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙˆØ§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…ÙØµÙ„Ø©"/>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet"/>

  <style>
    :root{
      --primary:#2D5F7C;--secondary:#4A90E2;--accent:#F5A623;
      --text:#333;--bg:#F8F9FA;--white:#fff;--border:#E0E0E0;
      --shadow:0 2px 12px rgba(0,0,0,.08);
      --success:#27AE60;--error:#E74C3C;
    }
    *{box-sizing:border-box} body{margin:0;font-family:'Cairo',sans-serif;background:var(--bg);color:var(--text)}
    a{color:inherit}
    header{position:sticky;top:0;z-index:50;background:var(--white);box-shadow:var(--shadow)}
    .nav{max-width:1200px;margin:auto;display:flex;align-items:center;justify-content:space-between;padding:12px 16px}
    .brand{display:flex;gap:10px;align-items:center;font-weight:700;color:var(--primary)}
    .actions{display:flex;gap:8px}
    .btn{border:none;border-radius:8px;padding:.65rem 1rem;cursor:pointer;font-family:inherit}
    .btn-primary{background:var(--primary);color:var(--white)}
    .btn-outline{background:transparent;color:var(--primary);border:2px solid var(--primary)}
    .btn-danger{background:var(--error);color:#fff}
    .btn-icon{display:inline-flex;gap:.45rem;align-items:center}
    .hero{background:linear-gradient(135deg,var(--primary),var(--secondary));color:#fff;padding:40px 0}
    .hero .wrap{max-width:1200px;margin:auto;padding:0 16px;display:grid;gap:16px}
    .hero h1{margin:0 0 10px}
    .stats{display:flex;gap:24px;flex-wrap:wrap}
    .stat{background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.25);padding:12px 16px;border-radius:12px}
    .container{max-width:1200px;margin:auto;padding:24px 16px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px}
    .card{background:#fff;border-radius:14px;box-shadow:var(--shadow);padding:14px}
    .card img{width:100%;height:180px;object-fit:cover;border-radius:10px;margin-bottom:10px;background:#f3f3f3}
    .meta{display:flex;gap:8px;flex-wrap:wrap;font-size:.9rem;color:#555;margin:.5rem 0}
    .empty{padding:48px;text-align:center;color:#777}
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.5);z-index:100}
    .modal.active{display:flex}
    .modal .box{background:#fff;border-radius:14px;max-width:520px;width:92%;box-shadow:var(--shadow);overflow:hidden}
    .box-header{padding:14px 18px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
    .box-body{padding:16px 18px}
    .row{display:grid;gap:10px}
    .row-2{grid-template-columns:1fr 1fr}
    label{font-weight:600;color:var(--primary)}
    input, select, textarea{width:100%;padding:.7rem;border:2px solid var(--border);border-radius:8px;font-family:inherit}
    textarea{min-height:100px;resize:vertical}
    .f-end{display:flex;justify-content:flex-end;gap:8px;margin-top:10px}
    .toast-wrap{position:fixed;top:16px;right:16px;z-index:200}
    .toast{background:var(--primary);color:#fff;padding:.8rem 1rem;border-radius:8px;margin-bottom:8px;box-shadow:var(--shadow)}
    .toast.error{background:var(--error)} .toast.success{background:var(--success)}
    @media(max-width:600px){.row-2{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <!-- Header -->
  <header>
    <nav class="nav">
      <div class="brand">ğŸ“ Ø¯Ù„ÙŠÙ„ <span style="font-weight:400;color:#777">| Ø¯Ù„ÙŠÙ„Ùƒ Ù„Ù„Ø®Ø¯Ù…Ø§Øª</span></div>
      <div class="actions">
        <button id="loginBtn" class="btn btn-outline btn-icon" onclick="openAuth('login')">Ø¯Ø®ÙˆÙ„</button>
        <button id="registerBtn" class="btn btn-primary btn-icon" onclick="openAuth('register')">ØªØ³Ø¬ÙŠÙ„</button>
        <button id="logoutBtn" class="btn btn-outline btn-icon" style="display:none" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
      </div>
    </nav>
  </header>

  <!-- Hero -->
  <section class="hero">
    <div class="wrap">
      <div>
        <h1>Ø¯Ù„ÙŠÙ„Ùƒ Ø§Ù„Ø´Ø§Ù…Ù„ Ù„Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø­ÙƒÙˆÙ…ÙŠØ© ÙˆØ§Ù„Ø¹Ø§Ù…Ø©</h1>
        <p style="opacity:.9">Ø§Ø³ØªÙƒØ´Ù Ø§Ù„Ø®Ø¯Ù…Ø§Øª ÙˆØ´Ø§Ø±Ùƒ ØªØ¬Ø±Ø¨ØªÙƒ Ù…Ø¹ Ø§Ù„Ø¢Ø®Ø±ÙŠÙ†</p>
      </div>
      <div class="stats">
        <div class="stat"><b id="statServices">0</b> Ø®Ø¯Ù…Ø©</div>
        <div class="stat"><b id="statUsers">0</b> Ù…Ø³ØªØ®Ø¯Ù…</div>
        <div class="stat"><b id="statReviews">0</b> ØªÙ‚ÙŠÙŠÙ…</div>
        <div class="stat"><button id="addServiceTop" class="btn btn-primary btn-icon" style="display:none" onclick="toggleAdd()">â• Ø£Ø¶Ù Ø®Ø¯Ù…Ø©</button></div>
      </div>
    </div>
  </section>

  <!-- Services -->
  <main class="container">
    <div id="services" class="grid"></div>
    <div id="empty" class="empty">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø®Ø¯Ù…Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹ â€” ÙƒÙ† Ø£ÙˆÙ„ Ù…Ù† ÙŠØ¶ÙŠÙ Ø®Ø¯Ù…Ø© âœ¨</div>
  </main>

  <!-- Add Service Modal -->
  <div id="addModal" class="modal" aria-hidden="true">
    <div class="box" role="dialog" aria-modal="true">
      <div class="box-header">
        <h3 style="margin:0">Ø¥Ø¶Ø§ÙØ© Ø®Ø¯Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©</h3>
        <button class="btn btn-outline" onclick="toggleAdd()">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
      <form id="serviceForm" class="box-body">
        <div class="row">
          <label for="svcName">Ø§Ø³Ù… Ø§Ù„Ø®Ø¯Ù…Ø©</label>
          <input id="svcName" placeholder="Ù…Ø«Ø§Ù„: Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø¬ÙˆØ§Ø² Ø³ÙØ±" required />
        </div>
        <div class="row row-2">
          <div>
            <label for="svcCat">Ø§Ù„Ù‚Ø³Ù…</label>
            <select id="svcCat" required>
              <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù…</option>
              <option>Ø­ÙƒÙˆÙ…ÙŠ</option><option>ØµØ­Ø©</option><option>ØªØ¹Ù„ÙŠÙ…</option><option>Ù…Ø§Ù„ÙŠ</option><option>Ø£Ø®Ø±Ù‰</option>
            </select>
          </div>
          <div>
            <label for="svcLoc">Ø§Ù„Ù…ÙƒØ§Ù†</label>
            <input id="svcLoc" placeholder="Ø§Ù„Ø±ÙŠØ§Ø¶ - Ø­ÙŠ Ø§Ù„Ù†Ø®ÙŠÙ„" required />
          </div>
        </div>
        <div class="row">
          <label for="svcDocs">Ø§Ù„Ø£ÙˆØ±Ø§Ù‚ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©</label>
          <textarea id="svcDocs" placeholder="Ø§Ø°ÙƒØ± Ø§Ù„Ø£ÙˆØ±Ø§Ù‚ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©..." required></textarea>
        </div>
        <div class="row row-2">
          <div>
            <label for="svcCost">Ø§Ù„ØªÙƒÙ„ÙØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
            <input id="svcCost" placeholder="Ù…Ø«Ø§Ù„: 100 Ø±ÙŠØ§Ù„"/>
          </div>
          <div>
            <label for="svcDur">Ø§Ù„Ù…Ø¯Ø© Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
            <input id="svcDur" placeholder="Ù…Ø«Ø§Ù„: 3-5 Ø£ÙŠØ§Ù…"/>
          </div>
        </div>
        <div class="row">
          <label for="svcNotes">Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <textarea id="svcNotes" placeholder="Ø£ÙŠ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù…ÙÙŠØ¯Ø©..."></textarea>
        </div>
        <div class="row">
          <label for="svcImg">ØµÙˆØ±Ø© Ø§Ù„Ø®Ø¯Ù…Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <input id="svcImg" type="file" accept="image/*"/>
        </div>
        <div class="f-end">
          <button type="button" class="btn" onclick="toggleAdd()">Ø¥Ù„ØºØ§Ø¡</button>
          <button type="submit" class="btn btn-primary btn-icon">ğŸ’¾ Ø­ÙØ¸</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Auth Modal -->
  <div id="authModal" class="modal" aria-hidden="true">
    <div class="box" role="dialog" aria-modal="true">
      <div class="box-header">
        <h3 id="authTitle" style="margin:0">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h3>
        <button class="btn btn-outline" onclick="closeAuth()">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
      <div class="box-body">
        <!-- Login -->
        <form id="loginForm" class="row" autocomplete="on">
          <div class="row">
            <label for="loginEmail">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
            <input id="loginEmail" type="email" placeholder="email@example.com" required />
          </div>
          <div class="row">
            <label for="loginPass">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
            <input id="loginPass" type="password" placeholder="******" required />
          </div>
          <div class="f-end">
            <button type="submit" class="btn btn-primary btn-icon">â¡ï¸ Ø¯Ø®ÙˆÙ„</button>
          </div>
        </form>

        <!-- Register -->
        <form id="registerForm" class="row" style="display:none" autocomplete="on">
          <div class="row">
            <label for="regEmail">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
            <input id="regEmail" type="email" placeholder="email@example.com" required />
          </div>
          <div class="row row-2">
            <div>
              <label for="regPass">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
              <input id="regPass" type="password" minlength="6" placeholder="6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„" required />
            </div>
            <div>
              <label for="regConfirm">ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
              <input id="regConfirm" type="password" minlength="6" placeholder="Ø£Ø¹Ø¯ ÙƒØªØ§Ø¨Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" required />
            </div>
          </div>
          <div class="f-end">
            <button type="submit" class="btn btn-primary btn-icon">ğŸ“ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
          </div>
        </form>

        <div style="margin-top:10px;text-align:center">
          <a href="#" onclick="switchAuth()">ØªØ¨Ø¯ÙŠÙ„ Ø¥Ù„Ù‰ <span id="switchLabel">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</span></a>
        </div>
      </div>
    </div>
  </div>

  <!-- Toasts -->
  <div id="toasts" class="toast-wrap"></div>

  <!-- Firebase + App -->
  <script type="module">
    /* ==== Firebase SDKs ==== */
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js';
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js';
    import { getFirestore, collection, addDoc, getDocs, query, orderBy, serverTimestamp, doc, deleteDoc } from 'https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js';
    import { getStorage, ref as sRef, uploadBytes, getDownloadURL, deleteObject } from 'https://www.gstatic.com/firebasejs/12.2.1/firebase-storage.js';

    /* ==== Config (Ø®Ø§ØµØ© Ø¨Ù…Ø´Ø±ÙˆØ¹Ùƒ) ==== */
    const firebaseConfig = {
      apiKey: "AIzaSyB6TzN-QHVUOwizABYxm0Y8fkqTp1qb_qA",
      authDomain: "daleel-c4204.firebaseapp.com",
      projectId: "daleel-c4204",
      storageBucket: "daleel-c4204.appspot.com",
      messagingSenderId: "864882936232",
      appId: "1:864882936232:web:5bfc14d7c0f02559d5f02d"
    };

    /* ==== Init ==== */
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    /* ==== State ==== */
    let currentUser = null;
    let services = [];

    /* ==== UI Helpers ==== */
    const $ = (s, p=document) => p.querySelector(s);
    function toast(msg, type='success'){
      const el = document.createElement('div');
      el.className = `toast ${type}`;
      el.textContent = msg;
      $('#toasts').appendChild(el);
      setTimeout(()=>el.remove(), 3200);
    }

    /* ==== Auth Modal ==== */
    function openAuth(mode='login'){
      $('#authModal').classList.add('active');
      if(mode==='register'){ $('#authTitle').textContent='Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨'; $('#loginForm').style.display='none'; $('#registerForm').style.display='grid'; $('#switchLabel').textContent='ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„'; }
      else { $('#authTitle').textContent='ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„'; $('#loginForm').style.display='grid'; $('#registerForm').style.display='none'; $('#switchLabel').textContent='Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨'; }
    }
    function closeAuth(){ $('#authModal').classList.remove('active'); $('#loginForm').reset(); $('#registerForm').reset(); }
    function switchAuth(){ if($('#loginForm').style.display!=='none') openAuth('register'); else openAuth('login'); }
    window.openAuth = openAuth; window.closeAuth = closeAuth; window.switchAuth = switchAuth;

    /* ==== Add Modal ==== */
    function toggleAdd(){ 
      if(!currentUser){ toast('ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹','error'); openAuth('login'); return; }
      $('#addModal').classList.toggle('active');
    }
    window.toggleAdd = toggleAdd;

    /* ==== Auth Handlers ==== */
    $('#registerForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const email = $('#regEmail').value.trim();
      const pass  = $('#regPass').value;
      const confirm = $('#regConfirm').value;
      if(pass!==confirm){ toast('ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚Ø©','error'); return; }
      try{
        await createUserWithEmailAndPassword(auth, email, pass);
        toast('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­'); closeAuth();
      }catch(err){ toast(mapAuthErr(err),'error'); console.error(err); }
    });

    $('#loginForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const email = $('#loginEmail').value.trim();
      const pass  = $('#loginPass').value;
      try{
        await signInWithEmailAndPassword(auth, email, pass);
        toast('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„'); closeAuth();
      }catch(err){ toast(mapAuthErr(err),'error'); console.error(err); }
    });

    function logout(){ signOut(auth).then(()=>toast('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬')).catch(e=>toast('Ø®Ø·Ø£: '+e.message,'error')); }
    window.logout = logout;

    function mapAuthErr(e){
      switch(e.code){
        case 'auth/email-already-in-use': return 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙØ¹Ù„';
        case 'auth/invalid-email': return 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ§Ù„Ø­';
        case 'auth/weak-password': return 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¶Ø¹ÙŠÙØ© (6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„)';
        case 'auth/user-not-found': return 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø­Ø³Ø§Ø¨ Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯';
        case 'auth/wrong-password': return 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©';
        default: return e.message;
      }
    }

    onAuthStateChanged(auth, (user)=>{
      currentUser = user;
      $('#loginBtn').style.display  = user ? 'none':'inline-block';
      $('#registerBtn').style.display= user ? 'none':'inline-block';
      $('#logoutBtn').style.display = user ? 'inline-block':'none';
      $('#addServiceTop').style.display = user ? 'inline-block':'none';
      loadServices(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø§Ù„Ø­Ø°Ù Ù„Ù…Ø§Ù„ÙÙƒ Ø§Ù„Ø®Ø¯Ù…Ø©)
      loadStats();
    });

    /* ==== Add Service ==== */
    $('#serviceForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      if(!currentUser){ toast('Ø³Ø¬Ù‘Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹','error'); return; }

      const name = $('#svcName').value.trim();
      const category = $('#svcCat').value;
      const location = $('#svcLoc').value.trim();
      const documents = $('#svcDocs').value.trim();
      const cost = $('#svcCost').value.trim() || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
      const duration = $('#svcDur').value.trim() || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
      const notes = $('#svcNotes').value.trim();
      const file = $('#svcImg').files[0];

      if(!name || !category || !location || !documents){ toast('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©','error'); return; }

      try{
        let imageUrl = ''; let imagePath = '';
        if(file){
          imagePath = `services/${currentUser.uid}/${Date.now()}-${file.name}`;
          const ref = sRef(storage, imagePath);
          const snap = await uploadBytes(ref, file);
          imageUrl = await getDownloadURL(snap.ref);
        }

        await addDoc(collection(db,'services'),{
          name, category, location,
          documents, cost, duration, notes,
          imageUrl, imagePath,
          userId: currentUser.uid,
          userEmail: currentUser.email,
          createdAt: serverTimestamp()
        });

        toast('ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø®Ø¯Ù…Ø© Ø¨Ù†Ø¬Ø§Ø­','success');
        $('#serviceForm').reset(); toggleAdd(); loadServices(); loadStats();
      }catch(err){ console.error(err); toast('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø¶Ø§ÙØ©: '+err.message,'error'); }
    });

    /* ==== Load & Render Services ==== */
    async function loadServices(){
      try{
        const q = query(collection(db,'services'), orderBy('createdAt','desc'));
        const snap = await getDocs(q);
        services = [];
        snap.forEach(d => services.push({ id:d.id, ...d.data() }));
        renderServices();
      }catch(err){ console.error(err); toast('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®Ø¯Ù…Ø§Øª','error'); }
    }

    function renderServices(){
      const wrap = $('#services'); wrap.innerHTML = '';
      if(services.length===0){ $('#empty').style.display='block'; return; }
      $('#empty').style.display='none';

      services.forEach(s=>{
        const isOwner = currentUser && s.userId === currentUser.uid;
        const card = document.createElement('div');
        card.className='card';
        card.innerHTML = `
          ${s.imageUrl ? `<img src="${s.imageUrl}" alt="${s.name}"/>` : ``}
          <h3 style="margin:.3rem 0">${s.name}</h3>
          <div class="meta"><span>ğŸ·ï¸ ${s.category}</span><span>ğŸ“ ${s.location}</span></div>
          <p><b>Ø§Ù„Ø£ÙˆØ±Ø§Ù‚:</b> ${escapeHTML(s.documents||'')}</p>
          ${s.cost && s.cost!=='ØºÙŠØ± Ù…Ø­Ø¯Ø¯' ? `<p><b>Ø§Ù„ØªÙƒÙ„ÙØ©:</b> ${escapeHTML(s.cost)}</p>`:''}
          ${s.duration && s.duration!=='ØºÙŠØ± Ù…Ø­Ø¯Ø¯' ? `<p><b>Ø§Ù„Ù…Ø¯Ø©:</b> ${escapeHTML(s.duration)}</p>`:''}
          ${s.notes ? `<p><b>Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</b> ${escapeHTML(s.notes)}</p>`:''}
          <small style="display:block;margin-top:8px;color:#666">Ø£Ø¶ÙŠÙØª Ø¨ÙˆØ§Ø³Ø·Ø©: ${s.userEmail || 'â€”'}</small>
          ${isOwner ? `<div class="f-end" style="margin-top:10px">
              <button class="btn btn-danger btn-icon" data-id="${s.id}">ğŸ—‘ï¸ Ø­Ø°Ù</button>
            </div>`:``}
        `;
        // attach delete if owner
        if(isOwner){
          const delBtn = card.querySelector('button.btn-danger');
          delBtn.addEventListener('click', ()=>confirmDelete(s));
        }
        wrap.appendChild(card);
      });
    }

    function escapeHTML(str){
      return String(str).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    async function confirmDelete(svc){
      if(!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø®Ø¯Ù…Ø©ØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„ØµÙˆØ±Ø© Ø£ÙŠØ¶Ø§Ù‹ Ø¥Ù† ÙˆØ¬Ø¯Øª.')) return;
      try{
        // 1) Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªÙ†Ø¯
        await deleteDoc(doc(db,'services', svc.id));
        // 2) Ø­Ø°Ù Ø§Ù„ØµÙˆØ±Ø© Ø¥Ù† ÙˆÙØ¬Ø¯Øª
        if(svc.imagePath){
          try{ await deleteObject(sRef(storage, svc.imagePath)); }catch(e){ console.warn('Image delete warning:', e.message); }
        }
        toast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø®Ø¯Ù…Ø©'); loadServices(); loadStats();
      }catch(err){ console.error(err); toast('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù: '+err.message,'error'); }
    }

    /* ==== Stats ==== */
    async function loadStats(){
      try{
        const snap = await getDocs(collection(db,'services'));
        $('#statServices').textContent = snap.size;

        const users = new Set();
        snap.forEach(d=>{ const u=d.data().userId; if(u) users.add(u); });
        $('#statUsers').textContent = users.size;

        $('#statReviews').textContent = '0'; // Placeholder Ù„Ø­ÙŠÙ† Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ù„Ø§Ø­Ù‚Ø§Ù‹
      }catch(e){
        $('#statServices').textContent='0'; $('#statUsers').textContent='0'; $('#statReviews').textContent='0';
      }
    }

    /* ==== Global keys (Esc closes modals) ==== */
    document.addEventListener('keydown', (e)=>{
      if(e.key==='Escape'){ $('#authModal').classList.remove('active'); $('#addModal').classList.remove('active'); }
    });
    document.querySelectorAll('.modal').forEach(m=>{
      m.addEventListener('click', (e)=>{ if(e.target===m) m.classList.remove('active'); });
    });
  </script>
</body>
</html>
